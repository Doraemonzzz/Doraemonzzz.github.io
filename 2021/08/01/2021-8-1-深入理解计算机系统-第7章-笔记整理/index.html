<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>深入理解计算机系统 第7章 笔记整理 | Doraemonzzz</title><meta name="keywords" content="深入理解计算机系统"><meta name="author" content="Doraemonzzz"><meta name="copyright" content="Doraemonzzz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这次回顾深入理解计算机系统第7章 ，这一章介绍了链接。 电子书地址： http:&#x2F;&#x2F;eol.bnuz.edu.cn&#x2F;meol&#x2F;common&#x2F;script&#x2F;preview&#x2F;download_preview.jsp?fileid&#x3D;2169600&amp;resid&#x3D;242120&amp;lid&#x3D;28605 备注：图片和总结内容均来自于电子书。">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解计算机系统 第7章 笔记整理">
<meta property="og:url" content="http://www.doraemonzzz.com/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/index.html">
<meta property="og:site_name" content="Doraemonzzz">
<meta property="og:description" content="这次回顾深入理解计算机系统第7章 ，这一章介绍了链接。 电子书地址： http:&#x2F;&#x2F;eol.bnuz.edu.cn&#x2F;meol&#x2F;common&#x2F;script&#x2F;preview&#x2F;download_preview.jsp?fileid&#x3D;2169600&amp;resid&#x3D;242120&amp;lid&#x3D;28605 备注：图片和总结内容均来自于电子书。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-08-01T03:35:00.000Z">
<meta property="article:modified_time" content="2021-08-01T04:09:41.498Z">
<meta property="article:author" content="Doraemonzzz">
<meta property="article:tag" content="深入理解计算机系统">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="https://github.com/Doraemonzzz/md-photo/blob/master/%E5%A4%B4%E5%83%8F.jpg?raw=true"><link rel="canonical" href="http://www.doraemonzzz.com/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6f00f37f957f0608abb8c571105456f0";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-G-RE4B1LKRZD"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-G-RE4B1LKRZD');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"距离上次更新已经","messageNext":"天了，文章内容可能已经过时。"},
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '深入理解计算机系统 第7章 笔记整理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-08-01 12:09:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="/css/bilibili.css" media="defer" onload="this.media='all'"><meta name="google-site-verification" content="c4v-NmuUZRgl3cvtg9GKswryK1YLaPztd_5M-df5VNI" /><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Doraemonzzz" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E5%A4%B4%E5%83%8F.jpg?raw=true" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">686</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">71</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-chart-pie"></i><span> 博客统计</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/charts/"><i class="fa-fw far fa-chart-bar"></i><span> 文章统计</span></a></li><li><a class="site-page child" href="/census/"><i class="fa-fw fas fa-chart-area"></i><span> 访问统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/top/"><i class="fa-fw fab fa-hotjar"></i><span> 阅读排行榜</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Doraemonzzz</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-chart-pie"></i><span> 博客统计</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/charts/"><i class="fa-fw far fa-chart-bar"></i><span> 文章统计</span></a></li><li><a class="site-page child" href="/census/"><i class="fa-fw fas fa-chart-area"></i><span> 访问统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/top/"><i class="fa-fw fab fa-hotjar"></i><span> 阅读排行榜</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">深入理解计算机系统 第7章 笔记整理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-01T03:35:00.000Z" title="发表于 2021-08-01 11:35:00">2021-08-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-08-01T04:09:41.498Z" title="更新于 2021-08-01 12:09:41">2021-08-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/">计算机原理</a></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/">深入理解计算机系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" data-flag-title="深入理解计算机系统 第7章 笔记整理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这次回顾深入理解计算机系统第7章 ，这一章介绍了链接。</p>
<p>电子书地址：</p>
<p><a target="_blank" rel="noopener" href="http://eol.bnuz.edu.cn/meol/common/script/preview/download_preview.jsp?fileid=2169600&amp;resid=242120&amp;lid=28605">http://eol.bnuz.edu.cn/meol/common/script/preview/download_preview.jsp?fileid=2169600&amp;resid=242120&amp;lid=28605</a></p>
<p>备注：图片和总结内容均来自于电子书。</p>
<span id="more"></span>
<h1 id="第7章：链接"><a href="#第7章：链接" class="headerlink" title="第7章：链接"></a>第7章：链接</h1><h2 id="重要概念提要"><a href="#重要概念提要" class="headerlink" title="重要概念提要"></a>重要概念提要</h2><ul>
<li>链接：<ul>
<li>概念以及作用；</li>
<li>执行时间：<ul>
<li>编译时；</li>
<li>加载时；</li>
<li>运行时；</li>
</ul>
</li>
</ul>
</li>
<li>gcc编译链接的过程：<ul>
<li>编译器驱动程序；</li>
<li>C预处理器；</li>
<li>C编译器；</li>
<li>汇编器；</li>
<li>链接器；</li>
</ul>
</li>
<li>静态链接：<ul>
<li>符号解析；</li>
<li>重定位；</li>
</ul>
</li>
<li>目标文件：<ul>
<li>可重定位目标文件；</li>
<li>可执行目标文件；</li>
<li>共享目标文件；</li>
</ul>
</li>
<li>EFL文件格式：<ul>
<li>.text</li>
<li>.data</li>
<li>.bss</li>
<li>COMMON</li>
</ul>
</li>
<li>符号和符号表：<ul>
<li>全局符号；<ul>
<li>强符号和弱符号；</li>
</ul>
</li>
<li>外部符号；</li>
<li>局部符号（static）；</li>
</ul>
</li>
<li>几种文件格式：<ul>
<li>静态库（.a）：将常用的函数的可执行目标文件打包为存档的形式。</li>
<li>可重定位目标文件（.o）；</li>
<li>可执行目标文件（.out）；</li>
<li>共享库（.so, .dll）；</li>
</ul>
</li>
<li>库打桩机制：<ul>
<li>截获对共享库的调用，取而代之执行自己的代码；</li>
</ul>
</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>链接：<ul>
<li>将各种代码和数据片段收集并组合成为一个单一文件的过程，该文件被加载(复制)到内存并执行。</li>
</ul>
</li>
<li>执行时间：<ul>
<li>编译时：源代码被翻译时；</li>
<li>加载时：被加载器加载到内存并执行时；</li>
<li>运行时：由程序自动执行；</li>
</ul>
</li>
<li>作用：<ul>
<li>分离编译，将大型程序分解为更好管理的小模块。</li>
</ul>
</li>
</ul>
<h2 id="7-1-编译器驱动程序"><a href="#7-1-编译器驱动程序" class="headerlink" title="7.1 编译器驱动程序"></a>7.1 编译器驱动程序</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>编译器驱动程序</li>
<li>C预处理器</li>
<li>C编译器</li>
<li>汇编器</li>
<li>链接器</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>通过示例理解上述概念。</p>
<p>main.c：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* main.c */</span>
<span class="token comment">/* $begin main */</span>
<span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/* $end main */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>sum.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* sum.c */</span>
<span class="token comment">/* $begin sum */</span>
<span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
        s <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>        
<span class="token comment">/* $end sum */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>linux中编译该程序的方法是：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -Og -o prog main.c sum.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里gcc就是编译驱动程序。</p>
<p>编译驱动程序实际上调用如下程序：</p>
<ul>
<li>C预处理器</li>
<li>C编译器</li>
<li>汇编器</li>
<li>链接器</li>
<li>加载器</li>
</ul>
<p>整个流程如下：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021071801.jpg?raw=true" alt=""></p>
<p>第一步通过C预处理器（cpp）将C程序源文件翻译成ASCII码的中间文件.i，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cpp <span class="token punctuation">[</span>other arguments<span class="token punctuation">]</span> main.c /tmp/main.i<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>第二步通过C编译器（cc1）将中间文件翻译为ASCII汇编文件.s，代码如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cc1 /tmp/main.i -Og <span class="token punctuation">[</span>other argument<span class="token punctuation">]</span> -o /tmp/main.s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>第三步通过编译器（as）将.s文件翻译为一个可重定位目标文件.o，代码如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">as <span class="token punctuation">[</span>other argument<span class="token punctuation">]</span> -o /tmp/main.o /tmp/main.s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>第四步利用链接器（ld）将.o文件以及一些必要的系统文件组合起来创建可执行文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ld -o prog <span class="token punctuation">[</span>system object files and args<span class="token punctuation">]</span> /tmp/main.o /tmp/sum.o<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后一步调用加载器将可执行程序复制到内存，然后执行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./prog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="7-2-静态链接"><a href="#7-2-静态链接" class="headerlink" title="7.2 静态链接"></a>7.2 静态链接</h2><p>可重定位目标文件的构成：</p>
<ol>
<li>代码；</li>
<li>数据节：包含初始化的全局变量以及未初始化的变量等等；</li>
</ol>
<p>静态链接的作用：</p>
<ol>
<li>符号解析：关联符号引用和符号解析；</li>
<li>重定位：指定符号在内存中的位置；</li>
</ol>
<h2 id="7-3-目标文件"><a href="#7-3-目标文件" class="headerlink" title="7.3 目标文件"></a>7.3 目标文件</h2><p>目标文件都包含二进制代码和数据，其三种形式为：</p>
<ul>
<li>可重定位目标文件。<ul>
<li>可以在编译时与其他可重定位目标文件合并起来，创建一个可执行目标文件。</li>
<li>由编译器和汇编器生成。</li>
</ul>
</li>
<li>可执行目标文件。<ul>
<li>可以被直接复制到内存并执行。</li>
<li>由连接器生成。</li>
</ul>
</li>
<li>共享目标文件。<ul>
<li>特殊的可重定位目标文件，可以在加载或运行时被动态地加载进内存并连接。</li>
<li>由编译器和汇编器生成。</li>
</ul>
</li>
</ul>
<p>各平台上目标文件的格式：</p>
<ul>
<li>Windows<ul>
<li>可移植可执行格式（Portable Executable, PE）。</li>
</ul>
</li>
<li>MacOS<ul>
<li>Mach-O格式。</li>
</ul>
</li>
<li>Linux<ul>
<li>可执行可链接格式（Executable and Linkable Format, ELF）。</li>
</ul>
</li>
</ul>
<h2 id="7-4-可重定位目标文件"><a href="#7-4-可重定位目标文件" class="headerlink" title="7.4 可重定位目标文件"></a>7.4 可重定位目标文件</h2><p>ELF可重定位目标文件格式：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021071802.jpg?raw=true" alt=""></p>
<p>作用介绍：</p>
<ul>
<li>ELF头：<ul>
<li>以16字节的序列开始，描述了生成该文件系统的字的大小和字节顺序；</li>
<li>ELF头的大小；</li>
<li>目标文件的类型；</li>
<li>机器类型（例如x86-64）；</li>
<li>节头部表的文件偏移；</li>
<li>节头部表中条目的大小和数量；</li>
</ul>
</li>
<li>节头部表：<ul>
<li>每个节的位置和大小；</li>
</ul>
</li>
<li>.text：<ul>
<li>已编译程序的机器代码；</li>
</ul>
</li>
<li>.rodata：<ul>
<li>只读数据，例如printf语句中的格式串等等；</li>
</ul>
</li>
<li>.data：<ul>
<li>已初始化的全局变量和静态C变量；</li>
</ul>
</li>
<li>.bss：<ul>
<li>未初始化的全局变量和静态C变量，以及所有被初始化为0的全局变量或C变量；</li>
<li>在目标文件中不占据实际空间，仅仅是占位符；</li>
<li>可以理解为Better Save Space；</li>
</ul>
</li>
<li>.symtab：<ul>
<li>符号表，存放程序中定义和引用的函数和全局变量信息，不包含局部变量的信息；</li>
</ul>
</li>
<li>.rel.text：<ul>
<li>.text节中位置的列表，链接时可能需要修改某些位置，可执行目标文件中通常不存在；</li>
</ul>
</li>
<li>.rel.data：<ul>
<li>被模块引用或定义的所有全局变量的重定位信息；</li>
</ul>
</li>
<li>.debug：<ul>
<li>调试符号表，包含程序种局部，全局变量，以及C源文件；</li>
</ul>
</li>
<li>.line：<ul>
<li>C源程序中的行号和.text节中机器指令的映射关系；</li>
</ul>
</li>
<li>.strtab：<ul>
<li>字符串表（即字符串序列），内容包括.symtab和.debug节中的符号表以及节头部中的节名字；</li>
</ul>
</li>
</ul>
<h2 id="7-5-符号和符号表"><a href="#7-5-符号和符号表" class="headerlink" title="7.5 符号和符号表"></a>7.5 符号和符号表</h2><h3 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h3><p>记当前可重定位目标模块为$m$。</p>
<p>符号类型：</p>
<ul>
<li>由模块$m$定义并能被其他模块引用的全局符号，对应于非静态的C函数和全局变量；</li>
<li>由其他模块定义并被模块$m$引用的全局符号，也称为外部符号，对应于在其他模块中定义的非静态C函数和全局变量；</li>
<li>只被模块$m$定义和引用的局部符号，对应于带static属性的C函数和全局变量，这些变量无法被其他模块引用；</li>
</ul>
<p>static的含义：</p>
<ul>
<li>C中，源文件扮演模块的角色，带有static属性声明的全局变量或者函数都是模块私有的。</li>
</ul>
<h3 id="符号表"><a href="#符号表" class="headerlink" title="符号表"></a>符号表</h3><p>符号表是条目的数组，每个条目的格式如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* $begin elfsymbol */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span> 
    <span class="token keyword">int</span>   name<span class="token punctuation">;</span>      <span class="token comment">/* String table offset */</span> 
    <span class="token keyword">char</span>  type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>    <span class="token comment">/* Function or data (4 bits) */</span> 
	  binding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">/* Local or global (4 bits) */</span> 
    <span class="token keyword">char</span>  reserved<span class="token punctuation">;</span>  <span class="token comment">/* Unused */</span>  
    <span class="token keyword">short</span> section<span class="token punctuation">;</span>   <span class="token comment">/* Section header index */</span>
    <span class="token keyword">long</span>  value<span class="token punctuation">;</span>     <span class="token comment">/* Section offset or absolute address */</span> 
    <span class="token keyword">long</span>  size<span class="token punctuation">;</span>      <span class="token comment">/* Object size in bytes */</span> 
<span class="token punctuation">&#125;</span> Elf64_Symbol<span class="token punctuation">;</span> 
<span class="token comment">/* $end elfsymbol */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>字段说明：</p>
<ul>
<li>name：<ul>
<li>字符串表中的字节偏移，字符串名字的位置；</li>
</ul>
</li>
<li>type：<ul>
<li>数据或函数；</li>
</ul>
</li>
<li>binding：<ul>
<li>表示符号是本地的还是全局的；</li>
</ul>
</li>
<li>reserved：<ul>
<li>未使用；</li>
</ul>
</li>
<li>section：<ul>
<li>符号被分配到目标文件的具体节；</li>
<li>节头部表的索引；<ul>
<li>有三个伪节在节头部表中没有条目（这些伪节只在可重定位目标文件中存在，可指定目标文件中不存在）：<ul>
<li>ABS：不该被重定位的符号；</li>
<li>UNDEF：未定义的符号（当前模块未定义，但是其他地方有定义）；</li>
<li>COMMON：未被分配位置的未初始化的数据目标；</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>value：<ul>
<li>符号的地址；</li>
<li>可重定位目标文件：距定义目标的节的起始位置偏移；</li>
<li>可执行目标文件：绝对运行时地址；</li>
</ul>
</li>
<li>size：<ul>
<li>目标的大小；</li>
</ul>
</li>
</ul>
<p>补充：</p>
<p>gcc中按照如下规定将可重定位目标文件中的符号分配到COMMON和.bss中：</p>
<ul>
<li>COMMON：未初始化的全局变量；</li>
<li>.bss：未初始化的静态变量，以及初始化为$0$的全局或静态变量；</li>
</ul>
<h2 id="7-6-符号解析"><a href="#7-6-符号解析" class="headerlink" title="7.6 符号解析"></a>7.6 符号解析</h2><h3 id="全局符号的分类"><a href="#全局符号的分类" class="headerlink" title="全局符号的分类"></a>全局符号的分类</h3><p>全局符号是强或者是弱的，定义如下：</p>
<ul>
<li>强：函数和已初始化的全局变量；</li>
<li>弱：未初始化的全局变量；</li>
</ul>
<p>链接器处理全局符号的规则：</p>
<ul>
<li>不允许有多个同名的强符号；</li>
<li>如果有一个强符号和多个弱符号同名，那么选择强符号；</li>
<li>如果有多个弱符号同名，那么从这些弱符号中任意选择一个；</li>
</ul>
<h3 id="静态库"><a href="#静态库" class="headerlink" title="静态库"></a>静态库</h3><p>理念：</p>
<ul>
<li>将常用的函数的可执行目标文件打包为存档的形式（.a格式）。</li>
</ul>
<p>优点：</p>
<ul>
<li>减少内存，不需要把全部函数链接。</li>
</ul>
<p>生成静态库的方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -c addvec.c  multvec.c 
ar rcs libvector.a addvec.o multvec.o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>使用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -c main2.c
gcc -static -o prog2c main2.o ./libvector.a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>或</p>
<pre class="line-numbers language-none"><code class="language-none">gcc -c main2.c
gcc -static -o prog2c main2.o -L -lvector<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>其中-L表示在当前目录下查找，lvector是libvector.a的缩写。</p>
<p>完整流程：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021071803.jpg?raw=true" alt=""></p>
<h3 id="使用静态库解析引用"><a href="#使用静态库解析引用" class="headerlink" title="使用静态库解析引用"></a>使用静态库解析引用</h3><p>使用静态库链接的一般形式如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -static s.a <span class="token punctuation">..</span>. f.c <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>静态库和C文件的放置顺序规则如下：</p>
<ul>
<li>如果库相互独立，则可以使用任意顺序；</li>
<li>如果库不是相互独立，那么需要进行排序，使得每个被存档文件的成员外部引用的符号$s$，在命令行中至少有一个$s$的定义是在对$s$引用之后的；</li>
</ul>
<h2 id="7-7-重定位"><a href="#7-7-重定位" class="headerlink" title="7.7 重定位"></a>7.7 重定位</h2><p>在符号解析完成后，代码中每个符号引用正好和符号定义（即一个输入目标模块中的一个符号表条目）关联起来，后续链接器进行重定位，一共分为两步：</p>
<ul>
<li>重定位节和符号定义<ul>
<li>将相同类型的节合并为聚合节，例如.data节被合并为可执行目标文件中的.data节。</li>
<li>将运行时内存地址赋给新的聚合节，输入模块定义的每个节以及输入模块定义的每个符号。</li>
</ul>
</li>
<li>重定位节中的符号引用<ul>
<li>利用重定位条目修改代码节和数据节中的符号引用。</li>
</ul>
</li>
</ul>
<h3 id="重定位条目"><a href="#重定位条目" class="headerlink" title="重定位条目"></a>重定位条目</h3><p>重定位条目告诉链接器在将目标文件合并成可执行目标文件时如何修改目标引用的位置，代码的重定位条目放在.rel.text中，已初始化数据的重定位条目放在.rel.data中。</p>
<p>ELF重定位条目的格式如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* $begin elfrelo */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span> 
    <span class="token keyword">long</span> offset<span class="token punctuation">;</span>    <span class="token comment">/* Offset of the reference to relocate */</span> 
    <span class="token keyword">long</span> type<span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span>   <span class="token comment">/* Relocation type */</span> 
	 	symbol<span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">/* Symbol table index */</span> 
    <span class="token keyword">long</span> addend<span class="token punctuation">;</span>    <span class="token comment">/* Constant part of relocation expression */</span>
<span class="token punctuation">&#125;</span> Elf64_Rela<span class="token punctuation">;</span> 
<span class="token comment">/* $end elfrelo */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>字段说明：</p>
<ul>
<li>offset：<ul>
<li>需要被修改的引用的节偏移；</li>
</ul>
</li>
<li>symbol：<ul>
<li>被修改的引用该指向的符号；</li>
</ul>
</li>
<li>type：<ul>
<li>告知链接器如何修改新的引用；</li>
<li>基本的类型：<ul>
<li>R_X86_64_PC32：重定位一个使用32位PC相对地址的引用，PC值为下一条指令的地址。</li>
<li>R_X86_64_32：重定位一个使用32位绝对地址的引用。</li>
</ul>
</li>
</ul>
</li>
<li>addend：<ul>
<li>有符号常数，用作偏移调整；</li>
</ul>
</li>
</ul>
<h3 id="重定位符号引用"><a href="#重定位符号引用" class="headerlink" title="重定位符号引用"></a>重定位符号引用</h3><p>重定位算法：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">foreach section s <span class="token punctuation">&#123;</span>
    foreach relocation entry r <span class="token punctuation">&#123;</span>
        refptr <span class="token operator">=</span> s <span class="token operator">+</span> r<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>  <span class="token comment">/* ptr to reference to be relocated */</span>
        
        <span class="token comment">/* Relocate a PC-relative reference */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>type <span class="token operator">==</span> R_X86_64_PC32<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            refaddr <span class="token operator">=</span> <span class="token function">ADDR</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>   <span class="token comment">/* ref's run-time address */</span>
            <span class="token operator">*</span>refptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ADDR</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>symbol<span class="token punctuation">)</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>addend <span class="token operator">-</span> refaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* Relocate an absolute reference */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>type <span class="token operator">==</span> R_X86_64_32<span class="token punctuation">)</span>
            <span class="token operator">*</span>refptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ADDR</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>symbo1<span class="token punctuation">)</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>addend<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<p>s表示节，r表示重定位条目，这里假设节s对应的地址ADDR(s)以及每个符号的运行时地址ADDR(r.symbol)都已知。</p>
<h2 id="7-8-可执行目标文件"><a href="#7-8-可执行目标文件" class="headerlink" title="7.8 可执行目标文件"></a>7.8 可执行目标文件</h2><p>可执行目标文件格式：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021072001.jpg?raw=true" alt=""></p>
<p>部分节的介绍：</p>
<ul>
<li>ELF头：<ul>
<li>描述文件的总体格式；</li>
<li>包括入口点（程序运行时第一条指令的地址）；</li>
</ul>
</li>
<li>.text：<ul>
<li>类似可重定位目标文件中的相同部分，但是已重定位到最终的运行时地址；</li>
</ul>
</li>
<li>.rodata：<ul>
<li>类似可重定位目标文件中的相同部分，但是已重定位到最终的运行时地址；</li>
</ul>
</li>
<li>.data：<ul>
<li>类似可重定位目标文件中的相同部分，但是已重定位到最终的运行时地址；</li>
</ul>
</li>
<li>.init：<ul>
<li>定义了程序初始化代码时调用的函数_init；</li>
</ul>
</li>
</ul>
<p>备注：可执行文件是完全连接的，所以没有.rel节。</p>
<h3 id="程序头部表"><a href="#程序头部表" class="headerlink" title="程序头部表"></a>程序头部表</h3><p>可执行文件的连续片被映射到连续的内存段，映射关系由程序头部表描述。</p>
<p>示例：</p>
<pre class="line-numbers language-none"><code class="language-none">LOAD off    0x0000000000000000 vaddr 0x0000000000400000 paddr 0x0000000000400000 align 2**21
     filesz 0x000000000000069c memsz 0x000000000000069c flags r-x
LOAD off    0x0000000000000df8 vaddr 0x0000000000600df8 paddr 0x0000000000600df8 align 2**21
     filesz 0x0000000000000228 memsz 0x0000000000000230 flags rw-<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>字段说明：</p>
<ul>
<li>off：目标文件中的偏移；</li>
<li>vaddr/paddr：内存地址；</li>
<li>align：对齐要求；</li>
<li>filesz：目标文件中的段大小；</li>
<li>memsz：内存中的段大小；</li>
<li>flags：运行时访问权限；</li>
</ul>
<p>约束：</p>
<pre class="line-numbers language-none"><code class="language-none">vaddr mod align &#x3D; off mod align<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="7-9-加载可执行目标文件"><a href="#7-9-加载可执行目标文件" class="headerlink" title="7.9 加载可执行目标文件"></a>7.9 加载可执行目标文件</h2><p>为了运行可执行目标文件prog，在linux shell命令行中会执行如下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./prog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该过程如下：</p>
<ul>
<li>shell判断prog是否是内置的shell命令，如果是否，则将prog视为可执行目标文件；</li>
<li>调用称为加载器的操作系统代码；</li>
<li>加载器将prog的代码和数据复制到内存中；<ul>
<li>该过程称为加载；</li>
</ul>
</li>
<li>通过跳转到程序的第一条指令或入口点来运行程序；</li>
</ul>
<p>加载器运行时，创建的内存映象如下：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021072201.jpg?raw=true" alt=""></p>
<p>对于加载和运行，更详细的步骤如下：</p>
<ul>
<li>加载器运行时创建类似上图的内存映像；</li>
<li>根据程序头部表，将可执行文件的片复制到代码段和数据段；</li>
<li>跳转到程序入口$\text{_start}$函数，该函数定义在$\text{ctrl.o}$中；</li>
<li>$\text{_start}$函数调用系统函数$\text{__lib_start_main}$，该函数定义在$\text{libc.so}$中；</li>
<li>$\text{__lib_start_main}$函数初始化执行环节，调用$\text{main}$函数；</li>
</ul>
<p>备注：</p>
<ul>
<li>由于.data段有对齐要求，所以代码段和数据段之间是有间隙的，上图中并没有表示这点；</li>
<li>分配栈，共享库和堆段运行时地址时，链接器会使用第三章提到的地址空间布局随机化；</li>
<li>尽管运行地址可能变化，但是相对位置是不变的；</li>
</ul>
<h2 id="7-10-动态链接共享库"><a href="#7-10-动态链接共享库" class="headerlink" title="7.10 动态链接共享库"></a>7.10 动态链接共享库</h2><p>静态库缺陷：</p>
<ul>
<li>需要定期维护，要使用最新的静态库，需要做以下两点：<ul>
<li>了解到库的更新情形；</li>
<li>显式的将程序和静态库链接；</li>
</ul>
</li>
<li>将标准I/O函数使用频率很高，将其代码复制到进程的文本段中很浪费内存资源；</li>
</ul>
<p>共享库（shared library）是为了解决上述缺陷的产物，其特点如下：</p>
<ul>
<li>是目标模块，在运行或加载时，可以加载到任意的内存地址并和内存中的程序链接起来；<ul>
<li>该过程程序动态链接；</li>
</ul>
</li>
<li>共享库也称为共享目标（shared object），Linux中以.so后缀来表示，windows中被称为DLL（动态链接库）</li>
</ul>
<p>共享库实现“共享”的方式：</p>
<ul>
<li>每个库只有一个.so文件，所有引用该库的可执行目标文件共享该.so文件的代码和数据；</li>
<li>共享库的.text节副本可以被不同正在运行的进程共享；</li>
</ul>
<p>动态链接过程：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021072202.jpg?raw=true" alt=""></p>
<p>生成共享库的指令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -shared -fpic -o libvector.so addvec.c multvec.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li>-fpic指示编译器生成位置无关代码；</li>
<li>-shared指示链接器创建共享目标文件；</li>
</ul>
<p>编译链接：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -o prog21 main2.c ./libvector.so<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li>该指令的含义是：创建可执行文件时，静态执行一些链接；程序加载时，动态执行一些链接；</li>
<li>此时没有任何libvector.so代码和数据节被复制到可执行文件prog21中；</li>
<li>只复制了一些重定位和符号表信息用以运行时解析libvector.so文件；</li>
<li>prog21包含.interp节，该节包含动态链接器的路径名；<ul>
<li>linux中动态链接器为ld-linux.so，也是一个共享目标；</li>
</ul>
</li>
</ul>
<p>对于包含动态链接的可执行目标文件，其运行流程如下（以prog21为例）：</p>
<ul>
<li>shell判断prog是否是内置的shell命令，如果是否，则将prog视为可执行目标文件；</li>
<li>调用称为加载器的操作系统代码；</li>
<li>加载器将prog的代码和数据复制到内存中；</li>
<li>运行动态链接器；<ul>
<li>重定位libc.so的文本和数据到某个内存段；</li>
<li>重定位libvector.so的文本和数据到某个内存段；</li>
<li>重定位prog21中所有由libc.so，libvector.so定义的符号引用；</li>
</ul>
</li>
<li>通过跳转到程序的第一条指令或入口点来运行程序；</li>
</ul>
<h2 id="7-11-从应用程序中加载和链接共享库"><a href="#7-11-从应用程序中加载和链接共享库" class="headerlink" title="7.11 从应用程序中加载和链接共享库"></a>7.11 从应用程序中加载和链接共享库</h2><p>Linux给动态链接器提供了简单的接口，运行应用程序在运行时加载和链接共享库。</p>
<p>dlopen接口：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>

返回<span class="token operator">:</span>若成功则为指向句柄的指针，若出错则为 <span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li>加载和链接共享库filename；</li>
<li>如果编译选项中带-rdynamic，则全局符号可用；</li>
<li>flag有两种选择：<ul>
<li>RTLD_NOW：立即解析对外部符号的引用；</li>
<li>RTLD_LAZY：推迟解析，直到执行来自库中代码；</li>
</ul>
</li>
</ul>
<p>dlsym接口：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">dlsym</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>

返回<span class="token operator">:</span>若成功则为指向符号的指针，若出错则为 <span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>handle：dlopen打开的句柄；</li>
<li>symbol：符号名称；</li>
</ul>
<p>dlclode接口：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span>

<span class="token keyword">int</span> <span class="token function">dlclose</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

返回<span class="token operator">:</span>若成功则为<span class="token number">0</span>，若出错则为<span class="token operator">-</span><span class="token number">1</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>卸载handle对应的共享库；</li>
</ul>
<p>dlerror接口：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

返回<span class="token operator">:</span>如果前面对dlopen、dlsym或 dlclose的调用失败，则为错误消息；如果前面的调用成功，则为 <span class="token constant">NULL</span>。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><p>代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* $begin dll */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span>

<span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> z<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>addvec<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>error<span class="token punctuation">;</span> 

    <span class="token comment">/* Dynamically load the shared library that contains addvec() */</span>
    handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"./libvector.so"</span><span class="token punctuation">,</span> RTLD_LAZY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Get a pointer to the addvec() function we just loaded */</span>
    addvec <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"addvec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>error <span class="token operator">=</span> <span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Now we can call addvec() just like any other function */</span>
    <span class="token function">addvec</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"z = [%d %d]\n"</span><span class="token punctuation">,</span> z<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> z<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Unload the shared library */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dlclose</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/* $end dll */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译指令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -rdynamic -o prog2r dll.c -ldl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="7-12-位置无关代码"><a href="#7-12-位置无关代码" class="headerlink" title="7.12 位置无关代码"></a>7.12 位置无关代码</h2><ul>
<li>可以加载而无需重定位的代码称为位置无关代码（Position-Independent Code，PIC）；</li>
<li>GCC中使用-fpic选项指示GNU编译系统生成PIC代码；</li>
<li>共享库的编译必须使用该选项；</li>
</ul>
<p>重要事实：</p>
<p>目标模块数据段和代码段的距离总是保持不变。</p>
<h3 id="PIC数据引用"><a href="#PIC数据引用" class="headerlink" title="PIC数据引用"></a>PIC数据引用</h3><ul>
<li>在数据开始处创建全局偏移量表（Global Offset Table, GOT）</li>
<li>所有被目标模块引用的全局数据目标（过程或全局变量）在GOT中都有一个8字节条目</li>
<li>编译器为每个条目生成一个重定位记录</li>
</ul>
<p>图示：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021072203.jpg?raw=true" alt=""></p>
<p>个人理解：</p>
<p>GOT记录全局数据目标的地址，该地址对应的值应该是可变的，所以代码段可以在GOT中定位到全局数据目标（注意GOT的位置是可以找到的，因为数据段和代码段的距离保持不变），</p>
<h3 id="PIC函数调用"><a href="#PIC函数调用" class="headerlink" title="PIC函数调用"></a>PIC函数调用</h3><p>使用延迟绑定技术，将过程地址的绑定推迟到第一次调用该过程时。</p>
<p>延迟绑定的实现使用了GOT和过程链接表（Procedure Linkage Table，PLT）。</p>
<p>如果一个目标模块调用定义在共享库中的任何函数，那么它就有自己的GOT和PLT；GOT是数据段的一部分，PLT是代码段的一部分。</p>
<p>流程：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E7%AC%AC7%E7%AB%A0/2021072204.jpg?raw=true" alt=""></p>
<p>个人理解：</p>
<ul>
<li>函数在GOT中有一个对应位置；</li>
<li>函数在PLT中有对应代码；</li>
<li>第一次调用函数时修改全局偏移量表中函数的地址（利用栈信息计算），然后跳转；</li>
<li>后续调用时根据全局偏移量表中函数的地址跳转；</li>
</ul>
<h2 id="7-13-库打桩机制"><a href="#7-13-库打桩机制" class="headerlink" title="7.13 库打桩机制"></a>7.13 库打桩机制</h2><p>Linux链接器支持库打桩（library interpositioning），其作用如下：</p>
<ul>
<li>截获对共享库的调用，取而代之执行自己的代码。</li>
</ul>
<p>后续内容的代码可以参考书籍网站。</p>
<h3 id="编译时打桩"><a href="#编译时打桩" class="headerlink" title="编译时打桩"></a>编译时打桩</h3><p>编译和链接：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -DCOMPILETIME -c mymalloc.c
gcc -I. -o intc int.c mymalloc.o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>含义：</p>
<p>-I.参数表示会进行打桩，具体来说，C预处理器在搜索系统目录之前，优先在当前目录中查找malloc.h。</p>
<h3 id="链接时打桩"><a href="#链接时打桩" class="headerlink" title="链接时打桩"></a>链接时打桩</h3><p>编译：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -DLINKTIME -c mymalloc.c
gcc -c int.c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>链接：</p>
<pre class="line-numbers language-none"><code class="language-none">gcc -W1,--wrap,malloc -W1,--wrap,free -o int1 int.o mymalloc.o<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>含义：</p>
<ul>
<li>Linux静态链接器支持用—wrap f标志进行打桩：<ul>
<li>把对符号$\text{f}$的引用解析成$\text{_ _wrap_f}$，把$\text{_ _real_f}$解析为$\text{f}$。</li>
</ul>
</li>
<li>-W1,option标志把option传递给链接器，option中每个逗号都要替换为一个空格。<ul>
<li>-W1,—wrap,malloc的含义为把—wrap malloc传递给链接器。</li>
</ul>
</li>
</ul>
<h3 id="运行时打桩"><a href="#运行时打桩" class="headerlink" title="运行时打桩"></a>运行时打桩</h3><ul>
<li>运行时打桩需要利用动态链接器的LD_PRELOAD环境变量<ul>
<li>LD_PRELOAD环境变量被设置为一个共享库路径名的列表（以空格或分号分隔）；</li>
<li>加载和执行程序时，动态链接器（LD-LINUX.SO）会优先搜索LD_PRELOAD库，然后才搜索其他库；</li>
</ul>
</li>
</ul>
<p>编译：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -DRUNTIME -shared -fpic -o mymalloc.so mymalloc.c -ldl
gcc -o intr int.c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>运行（bash）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">LD_PRELOAD</span><span class="token operator">=</span><span class="token string">"./mymalloc.so"</span> ./intr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="7-14-处理目标文件的工具"><a href="#7-14-处理目标文件的工具" class="headerlink" title="7.14 处理目标文件的工具"></a>7.14 处理目标文件的工具</h2><p>处理目标文件的Linux工具：</p>
<ul>
<li>AR：创建静态库，插人、删除、列出和提取成员。</li>
<li>STRINGS：列出一个目标文件中所有可打印的字符串。</li>
<li>STRIP：从目标文件中删除符号表信息。</li>
<li>NM：列出一个目标文件的符号表中定义的符号。</li>
<li>SIZE：列出目标文件中节的名字和大小。</li>
<li>READELF：显示一个目标文件的完整结构，包括ELF头中编码的所有信息。包含SIZE和NM的功能。</li>
<li>OBJDUMP：所有二进制工具之母。能够显示一个目标文件中所有的信息。它最大的作用是反汇编.text节中的二进制指令。</li>
</ul>
<p>操作共享库的程序：</p>
<ul>
<li>LDD：列出一个可执行文件在运行时所需要的共享库。</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Doraemonzzz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.doraemonzzz.com/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/">http://www.doraemonzzz.com/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.doraemonzzz.com" target="_blank">Doraemonzzz</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/">深入理解计算机系统</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/08/01/2021-8-01-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC7%E7%AB%A0-%E4%B9%A0%E9%A2%98%E8%A7%A3%E6%9E%90/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">深入理解计算机系统 第7章 习题解析</div></div></a></div><div class="next-post pull-right"><a href="/2021/08/01/2021-8-1-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E7%AC%AC6%E7%AB%A0-%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/"><img class="next-cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">深入理解计算机系统 第6章 笔记整理</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/25/2021-10-25-深入理解计算机系统-第12章-习题解析/" title="深入理解计算机系统 第12章 习题解析"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-25</div><div class="title">深入理解计算机系统 第12章 习题解析</div></div></a></div><div><a href="/2021/06/06/2021-6-6-深入理解计算机系统-第5章-习题解析/" title="深入理解计算机系统 第5章 习题解析"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-06</div><div class="title">深入理解计算机系统 第5章 习题解析</div></div></a></div><div><a href="/2021/08/01/2021-8-01-深入理解计算机系统-第7章-习题解析/" title="深入理解计算机系统 第7章 习题解析"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-01</div><div class="title">深入理解计算机系统 第7章 习题解析</div></div></a></div><div><a href="/2021/08/01/2021-8-1-深入理解计算机系统-第6章-笔记整理/" title="深入理解计算机系统 第6章 笔记整理"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-01</div><div class="title">深入理解计算机系统 第6章 笔记整理</div></div></a></div><div><a href="/2021/08/15/2021-8-15-深入理解计算机系统-第8章-习题解析/" title="深入理解计算机系统 第8章 习题解析"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-15</div><div class="title">深入理解计算机系统 第8章 习题解析</div></div></a></div><div><a href="/2021/09/14/2021-9-14-深入理解计算机系统-第9章-习题解析/" title="深入理解计算机系统 第9章 习题解析"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-14</div><div class="title">深入理解计算机系统 第9章 习题解析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Livere</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="lv-container" data-id="city" data-uid="MTAyMC8zNDcxOS8xMTI1Ng=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "/img/loading.gif" data-lazy-src="https://github.com/Doraemonzzz/md-photo/blob/master/%E5%A4%B4%E5%83%8F.jpg?raw=true" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Doraemonzzz</div><div class="author-info__description">个人博客，主要记录有关机器学习，数学以及计算机科学的笔记</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">686</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">71</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Doraemonzzz"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Doraemonzzz" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/doraemon_zzz@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/291079982" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">暂无公告</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC7%E7%AB%A0%EF%BC%9A%E9%93%BE%E6%8E%A5"><span class="toc-number">1.</span> <span class="toc-text">第7章：链接</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5%E6%8F%90%E8%A6%81"><span class="toc-number">1.1.</span> <span class="toc-text">重要概念提要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E7%BC%96%E8%AF%91%E5%99%A8%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.3.</span> <span class="toc-text">7.1 编译器驱动程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.3.2.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">1.4.</span> <span class="toc-text">7.2 静态链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.</span> <span class="toc-text">7.3 目标文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E5%8F%AF%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.</span> <span class="toc-text">7.4 可重定位目标文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E7%AC%A6%E5%8F%B7%E5%92%8C%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">1.7.</span> <span class="toc-text">7.5 符号和符号表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7"><span class="toc-number">1.7.1.</span> <span class="toc-text">符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">1.7.2.</span> <span class="toc-text">符号表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-6-%E7%AC%A6%E5%8F%B7%E8%A7%A3%E6%9E%90"><span class="toc-number">1.8.</span> <span class="toc-text">7.6 符号解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%AC%A6%E5%8F%B7%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.8.1.</span> <span class="toc-text">全局符号的分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%BA%93"><span class="toc-number">1.8.2.</span> <span class="toc-text">静态库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%9D%99%E6%80%81%E5%BA%93%E8%A7%A3%E6%9E%90%E5%BC%95%E7%94%A8"><span class="toc-number">1.8.3.</span> <span class="toc-text">使用静态库解析引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-7-%E9%87%8D%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.9.</span> <span class="toc-text">7.7 重定位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E6%9D%A1%E7%9B%AE"><span class="toc-number">1.9.1.</span> <span class="toc-text">重定位条目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%AC%A6%E5%8F%B7%E5%BC%95%E7%94%A8"><span class="toc-number">1.9.2.</span> <span class="toc-text">重定位符号引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-8-%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="toc-number">1.10.</span> <span class="toc-text">7.8 可执行目标文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%A4%B4%E9%83%A8%E8%A1%A8"><span class="toc-number">1.10.1.</span> <span class="toc-text">程序头部表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-9-%E5%8A%A0%E8%BD%BD%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="toc-number">1.11.</span> <span class="toc-text">7.9 加载可执行目标文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-10-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%85%B1%E4%BA%AB%E5%BA%93"><span class="toc-number">1.12.</span> <span class="toc-text">7.10 动态链接共享库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-11-%E4%BB%8E%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%AD%E5%8A%A0%E8%BD%BD%E5%92%8C%E9%93%BE%E6%8E%A5%E5%85%B1%E4%BA%AB%E5%BA%93"><span class="toc-number">1.13.</span> <span class="toc-text">7.11 从应用程序中加载和链接共享库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.13.1.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-12-%E4%BD%8D%E7%BD%AE%E6%97%A0%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="toc-number">1.14.</span> <span class="toc-text">7.12 位置无关代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PIC%E6%95%B0%E6%8D%AE%E5%BC%95%E7%94%A8"><span class="toc-number">1.14.1.</span> <span class="toc-text">PIC数据引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PIC%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-number">1.14.2.</span> <span class="toc-text">PIC函数调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-13-%E5%BA%93%E6%89%93%E6%A1%A9%E6%9C%BA%E5%88%B6"><span class="toc-number">1.15.</span> <span class="toc-text">7.13 库打桩机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E6%97%B6%E6%89%93%E6%A1%A9"><span class="toc-number">1.15.1.</span> <span class="toc-text">编译时打桩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E6%97%B6%E6%89%93%E6%A1%A9"><span class="toc-number">1.15.2.</span> <span class="toc-text">链接时打桩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%89%93%E6%A1%A9"><span class="toc-number">1.15.3.</span> <span class="toc-text">运行时打桩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-14-%E5%A4%84%E7%90%86%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">1.16.</span> <span class="toc-text">7.14 处理目标文件的工具</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-HW1/" title="Programming Languages Part A HW1"><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Programming Languages Part A HW1"/></a><div class="content"><a class="title" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-HW1/" title="Programming Languages Part A HW1">Programming Languages Part A HW1</a><time datetime="2022-01-10T14:11:00.000Z" title="发表于 2022-01-10 22:11:00">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-HW0/" title="Programming Languages Part A HW0"><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Programming Languages Part A HW0"/></a><div class="content"><a class="title" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-HW0/" title="Programming Languages Part A HW0">Programming Languages Part A HW0</a><time datetime="2022-01-10T14:09:00.000Z" title="发表于 2022-01-10 22:09:00">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-Week-2%E7%AC%94%E8%AE%B0/" title="Programming Languages Part A Week 2笔记"><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Programming Languages Part A Week 2笔记"/></a><div class="content"><a class="title" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-Week-2%E7%AC%94%E8%AE%B0/" title="Programming Languages Part A Week 2笔记">Programming Languages Part A Week 2笔记</a><time datetime="2022-01-10T14:05:00.000Z" title="发表于 2022-01-10 22:05:00">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-Week-1%E7%AC%94%E8%AE%B0/" title="Programming Languages Part A Week 1笔记"><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Programming Languages Part A Week 1笔记"/></a><div class="content"><a class="title" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-Week-1%E7%AC%94%E8%AE%B0/" title="Programming Languages Part A Week 1笔记">Programming Languages Part A Week 1笔记</a><time datetime="2022-01-10T13:58:00.000Z" title="发表于 2022-01-10 21:58:00">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-Section1-%E7%BF%BB%E8%AF%91/" title="Programming Languages Part A Section1 翻译"><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Programming Languages Part A Section1 翻译"/></a><div class="content"><a class="title" href="/2022/01/10/2022-1-10-Programming-Languages-Part-A-Section1-%E7%BF%BB%E8%AF%91/" title="Programming Languages Part A Section1 翻译">Programming Languages Part A Section1 翻译</a><time datetime="2022-01-10T13:15:00.000Z" title="发表于 2022-01-10 21:15:00">2022-01-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2022 By Doraemonzzz</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.25
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'IpnmxCW9CvYWIXbol5QXsegX-MdYXbMMI',
      appKey: 'w57DVCdbxcyB1TYYagMIMJIU',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: true
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Valine' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>